<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–í—Ä–µ–º–µ–Ω–Ω–∞—è –ø–æ—á—Ç–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ... –°—Ç–∏–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ—Ö–æ–∂–∏ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é "–º–æ–±–∏–ª—å–Ω—É—é" –≤–µ—Ä—Å–∏—é ... */
        :root { /* ... –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ... */
             --app-bg-color: var(--tg-theme-bg-color, #f0f0f0); --app-text-color: var(--tg-theme-text-color, #000000); --app-hint-color: var(--tg-theme-hint-color, #777777); --app-link-color: var(--tg-theme-link-color, #007bff); --app-button-color: var(--tg-theme-button-color, #007bff); --app-button-text-color: var(--tg-theme-button-text-color, #ffffff); --app-secondary-bg-color: var(--tg-theme-secondary-bg-color, #ffffff); --app-destructive-text-color: var(--tg-theme-destructive-text-color, #dc3545); --border-radius: 12px; --container-padding: 15px; --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; --transition-speed: 0.2s;
        }
        * { box-sizing: border-box; }
        html { font-family: var(--font-family); line-height: 1.5; -webkit-text-size-adjust: 100%; }
        body { margin: 0; padding: var(--container-padding); background-color: var(--app-bg-color); color: var(--app-text-color); font-size: 16px; display: flex; flex-direction: column; min-height: 100vh; overscroll-behavior: none; transition: background-color var(--transition-speed), color var(--transition-speed); }
        .main-title { font-size: 1.8em; font-weight: 600; color: var(--app-text-color); text-align: center; margin: 0 0 20px 0; line-height: 1.3; }
        .section { background-color: var(--app-secondary-bg-color); border-radius: var(--border-radius); padding: var(--container-padding); margin-bottom: 15px; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08); transition: background-color var(--transition-speed); }
        .section-title { font-size: 1.1em; font-weight: 600; margin-top: 0; margin-bottom: 12px; color: var(--app-text-color); transition: color var(--transition-speed); }
        .email-display { display: flex; align-items: center; border: 1px solid var(--app-hint-color); background-color: var(--app-bg-color); border-radius: calc(var(--border-radius) / 1.5); padding: 10px 12px; margin-bottom: 15px; cursor: pointer; transition: background-color var(--transition-speed), border-color var(--transition-speed); overflow: hidden; color: var(--app-text-color); min-height: 44px; }
        .email-display:hover { border-color: var(--app-link-color); }
        #email-address { flex-grow: 1; font-size: 1em; overflow-wrap: break-word; word-break: break-all; line-height: 1.4; }
        #email-address.placeholder { color: var(--app-hint-color); }
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .button { display: flex; align-items: center; justify-content: center; background-color: var(--app-button-color); color: var(--app-button-text-color); border: none; border-radius: calc(var(--border-radius) / 1.5); padding: 10px 15px; font-size: 0.95em; font-weight: 500; cursor: pointer; transition: background-color var(--transition-speed), opacity var(--transition-speed), transform 0.1s; flex-grow: 1; text-align: center; min-height: 40px; -webkit-tap-highlight-color: transparent; }
        .button:active:not(:disabled) { transform: scale(0.97); opacity: 0.85; }
        .button:disabled { background-color: var(--app-hint-color); opacity: 0.7; cursor: not-allowed; transform: none; }
        .button .icon { margin-right: 8px; font-size: 1.1em; display: inline-block; line-height: 1; }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        #inbox-list { display: flex; flex-direction: column; gap: 8px; min-height: 100px; }
        .inbox-placeholder { display: flex; justify-content: center; align-items: center; flex-grow: 1; padding: 20px; text-align: center; color: var(--app-hint-color); min-height: 100px; }
        .inbox-placeholder .icon { margin-right: 8px; }
        .inbox-placeholder.error { color: var(--app-destructive-text-color); font-weight: 500; }
        .message-item { border: 1px solid var(--tg-theme-hint-color, #dee2e6); border-radius: calc(var(--border-radius) / 2); padding: 10px 12px; background-color: var(--app-bg-color); transition: background-color var(--transition-speed), border-color var(--transition-speed); opacity: 0; transform: translateY(5px); animation: fadeIn 0.4s ease-out forwards; cursor: pointer; color: var(--app-text-color); }
        .message-item:hover { border-color: var(--app-link-color); background-color: var(--app-secondary-bg-color); }
        .message-item span { display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .message-item .sender { font-weight: 600; margin-bottom: 2px; font-size: 0.9em; }
        .message-item .subject { font-weight: 500; margin-bottom: 3px; font-size: 0.85em; }
        .message-item .intro { font-size: 0.8em; color: var(--app-hint-color); }
        #message-view { display: none; }
        .message-header { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--app-hint-color); }
        .message-header div { margin-bottom: 5px; font-size: 0.9em; word-break: break-all; }
        .message-header strong { font-weight: 600; margin-right: 5px; color: var(--app-text-color); }
        .message-body { margin-top: 15px; font-size: 0.95em; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; max-height: 50vh; overflow-y: auto; padding: 10px; background-color: var(--app-bg-color); border-radius: calc(var(--border-radius) / 2); border: 1px solid var(--app-hint-color); }
        #back-to-inbox-btn { margin-top: 20px; flex-grow: 0; width: auto; background-color: var(--app-hint-color); color: var(--app-secondary-bg-color); }
        #message-view-loader { text-align: center; padding: 30px; color: var(--app-hint-color); }
        .footer { text-align: center; margin-top: auto; padding-top: 20px; padding-bottom: 10px; font-size: 0.8em; color: var(--app-hint-color); }
        .footer a { color: var(--app-link-color); text-decoration: none; }
        .footer a:hover { text-decoration: underline; }
        .toast-notification { position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.7); color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.9em; z-index: 1001; opacity: 0; transition: opacity 0.4s ease-out, bottom 0.4s ease-out; pointer-events: none; }
        .toast-notification.show { opacity: 1; bottom: 80px; }
        .toast-notification.success { background-color: rgba(40, 167, 69, 0.8); }
        .toast-notification.error { background-color: rgba(220, 53, 69, 0.8); }
        .toast-notification.warning { background-color: rgba(255, 193, 7, 0.8); color: black; }
    </style>
</head>
<body>
    <!-- HTML –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–µ–º –∂–µ -->
    <h1 class="main-title">–í—Ä–µ–º–µ–Ω–Ω–∞—è –ø–æ—á—Ç–∞</h1>

    <div class="section" id="account-section">
        <div class="section-title">–í–∞—à –∞–¥—Ä–µ—Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ—á—Ç—ã</div>
        <div class="email-display" id="email-display" title="">
            <span id="email-address" class="placeholder">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</span> <!-- –ò–∑–º–µ–Ω–µ–Ω–æ -->
        </div>
        <div class="action-buttons">
            <button class="button" id="change-email-btn" disabled><span class="icon">‚è≥</span>...</button> <!-- –ò–∑–º–µ–Ω–µ–Ω–æ -->
            <button class="button" id="refresh-inbox-btn" disabled><span class="icon">‚è≥</span>...</button> <!-- –ò–∑–º–µ–Ω–µ–Ω–æ -->
        </div>
    </div>

    <div class="section" id="inbox-section">
        <div class="section-title">–í—Ö–æ–¥—è—â–∏–µ</div>
        <div id="inbox-list">
            <div class="inbox-placeholder">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div> <!-- –ò–∑–º–µ–Ω–µ–Ω–æ -->
        </div>
    </div>

    <div id="message-view" class="section">
        <div id="message-view-content"></div>
        <button class="button" id="back-to-inbox-btn"><span class="icon">‚¨ÖÔ∏è</span> –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</button>
    </div>

    <div class="footer">
        <a href="https://mail.tm" target="_blank" rel="noopener noreferrer">Powered by Mail.tm</a>
    </div>

    <div id="toast-notification" class="toast-notification"></div>

    <script>
        // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã ---
        const API_BASE_URL = 'https://api.mail.tm';
        const LS_KEY = 'tempMailAccountData';
        const POLLING_INTERVAL = 20000;
        let currentAccount = null;
        let apiToken = null;
        let pollingIntervalId = null;
        let displayedMessageIds = new Set();
        // –£–ø—Ä–æ—â–∞–µ–º —Ñ–ª–∞–≥–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è: —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ñ–ª–∞–≥ –¥–ª—è –ª—é–±–æ–π –∞–∫—Ç–∏–≤–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
        let isBusy = false;

        // --- –≠–ª–µ–º–µ–Ω—Ç—ã DOM ---
        const emailAddressEl = document.getElementById('email-address');
        const emailDisplayEl = document.getElementById('email-display');
        const inboxListEl = document.getElementById('inbox-list');
        const changeEmailBtn = document.getElementById('change-email-btn');
        const refreshInboxBtn = document.getElementById('refresh-inbox-btn');
        const toastNotificationEl = document.getElementById('toast-notification');
        const backToInboxBtn = document.getElementById('back-to-inbox-btn');
        // –î–æ—Å—Ç–∞–µ–º –Ω—É–∂–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å—Ä–∞–∑—É
        const accountSectionEl = document.getElementById('account-section');
        const inboxSectionEl = document.getElementById('inbox-section');
        const messageViewEl = document.getElementById('message-view');
        const messageViewContentEl = document.getElementById('message-view-content');


        // --- –£—Ç–∏–ª–∏—Ç—ã ---
        let toastTimeout;
        const showToast = (message, type = 'info', duration = 3000) => { clearTimeout(toastTimeout); toastNotificationEl.textContent = message; toastNotificationEl.className = `toast-notification ${type}`; requestAnimationFrame(() => { toastNotificationEl.classList.add('show'); }); toastTimeout = setTimeout(() => { toastNotificationEl.classList.remove('show'); }, duration); };
        const generatePassword = (length = 12) => { const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"; let password = ""; for (let i = 0, n = charset.length; i < length; ++i) password += charset.charAt(Math.floor(Math.random() * n)); return password; };
        const escapeHtml = (unsafe = '') => { const temp = document.createElement('div'); temp.textContent = unsafe; return temp.innerHTML; };

        // –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∫–Ω–æ–ø–æ–∫
        const setButtonsBusy = (busy, operation = null) => {
            isBusy = busy;
            changeEmailBtn.disabled = busy;
            // –ö–Ω–æ–ø–∫—É –æ–±–Ω–æ–≤–∏—Ç—å –±–ª–æ–∫–∏—Ä—É–µ–º —Ç–∞–∫–∂–µ –µ—Å–ª–∏ –Ω–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞
            refreshInboxBtn.disabled = busy || !currentAccount;

            if (busy) {
                if (operation === 'change') {
                    changeEmailBtn.innerHTML = `<span class="icon">‚è≥</span>–°–º–µ–Ω–∞...`;
                    refreshInboxBtn.innerHTML = `<span class="icon">‚è≥</span>...`; // –¢–æ–∂–µ –±–ª–æ–∫–∏—Ä—É–µ–º
                } else if (operation === 'refresh') {
                    refreshInboxBtn.innerHTML = `<span class="icon">üîÑ</span>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...`;
                    changeEmailBtn.innerHTML = `<span class="icon">‚è≥</span>...`; // –¢–æ–∂–µ –±–ª–æ–∫–∏—Ä—É–µ–º
                } else { // –û–±—â–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ –ø–∏—Å—å–º–∞)
                    changeEmailBtn.innerHTML = `<span class="icon">‚è≥</span>–ó–∞–Ω—è—Ç–æ...`;
                    refreshInboxBtn.innerHTML = `<span class="icon">‚è≥</span>–ó–∞–Ω—è—Ç–æ...`;
                }
            } else {
                changeEmailBtn.innerHTML = `<span class="icon">‚ùå</span>–°–º–µ–Ω–∏—Ç—å e-mail`;
                refreshInboxBtn.innerHTML = `<span class="icon">üîÑ</span>–û–±–Ω–æ–≤–∏—Ç—å`;
            }
        };

        // --- –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å API Mail.tm ---
        // (fetchAPI –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –≤—Å–µ –µ—â–µ –±–µ–∑ –∞–≤—Ç–æ-getToken)
        async function fetchAPI(endpoint, options = {}) {
            const { method = 'GET', body = null, needsAuth = true } = options;
            const url = API_BASE_URL + endpoint;
            const headers = { 'Accept': 'application/ld+json' };
            if (body) headers['Content-Type'] = 'application/json';

            if (needsAuth) {
                if (!apiToken) { throw new Error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: —Ç–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç."); }
                headers['Authorization'] = `Bearer ${apiToken}`;
            }
            console.log(`API Request: ${method} ${endpoint}`);
            try {
                const response = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : null });
                if (response.status === 204) return { ok: true, data: null };
                const responseBodyText = await response.text(); let data = null;
                if (responseBodyText) { try { data = JSON.parse(responseBodyText); } catch (e) { if (response.ok) return { ok: true, data: responseBodyText }; throw new Error(`Invalid server response (status ${response.status}, not JSON)`); } }
                if (!response.ok) { const errorMessage = data?.message || data?.detail || `API Error: ${response.status}`; if (response.status === 401 && needsAuth) { apiToken = null; throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (401)."); } throw new Error(errorMessage); }
                return { ok: true, data };
            } catch (error) { console.error(`API Fetch/Process Error: ${method} ${endpoint}`, error); if (!error.message.includes('401')) { showToast(`API Error: ${error.message}`, 'error');} return { ok: false, error: error }; }
        }


        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ UI ---
        const updateAccountUI = (status = 'ok') => {
            if (status === 'loading') {
                emailAddressEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞...';
                emailAddressEl.classList.add('placeholder');
                emailDisplayEl.title = ''; emailDisplayEl.style.cursor = 'default';
            } else if (status === 'error' || !currentAccount?.address) {
                emailAddressEl.textContent = '–û—à–∏–±–∫–∞ / –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞';
                emailAddressEl.classList.add('placeholder');
                emailDisplayEl.title = ''; emailDisplayEl.style.cursor = 'default';
            } else { // status === 'ok'
                emailAddressEl.textContent = currentAccount.address;
                emailAddressEl.classList.remove('placeholder');
                emailDisplayEl.title = '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
                emailDisplayEl.style.cursor = 'pointer';
            }
        };
        const setInboxState = (state, message = '') => { /* ... –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ ... */
            console.log(`UI: Inbox state -> '${state}'` + (message ? `: ${message}` : ''));
            inboxListEl.innerHTML = ''; inboxListEl.classList.remove('has-messages');
            const placeholder = document.createElement('div'); placeholder.className = 'inbox-placeholder';
            let showPlaceholder = true;
            switch(state) {
                case 'loading': placeholder.innerHTML = '<span class="icon">‚è≥</span> –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...'; break;
                case 'empty': placeholder.textContent = '–ù–µ—Ç –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π'; break;
                case 'error': placeholder.textContent = `–û—à–∏–±–∫–∞: ${escapeHtml(message)}`; placeholder.classList.add('error'); break;
                case 'messages': showPlaceholder = false; break;
                default: placeholder.textContent = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ'; placeholder.classList.add('error');
            }
            if(showPlaceholder) inboxListEl.appendChild(placeholder);
        };
        const displayMessages = (messages = []) => { /* ... –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */
             if (messages.length > 0 || displayedMessageIds.size > 0) inboxListEl.innerHTML = '';
             if (!messages.length) { setInboxState('empty'); displayedMessageIds.clear(); return; }
             setInboxState('messages'); inboxListEl.classList.add('has-messages');
             messages.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
             const fragment = document.createDocumentFragment(); const currentIds = new Set();
             messages.forEach(msg => { currentIds.add(msg.id); const msgDiv = document.createElement('div'); msgDiv.classList.add('message-item'); msgDiv.dataset.messageId = msg.id; const sender = escapeHtml(msg.from?.address || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'); const subject = escapeHtml(msg.subject || '(–ë–µ–∑ —Ç–µ–º—ã)'); const intro = escapeHtml(msg.intro || ''); msgDiv.innerHTML = `<span class="sender" title="${sender}">${sender}</span><span class="subject" title="${subject}">${subject}</span>${intro ? `<span class="intro" title="${intro}">${intro}</span>` : ''}`; msgDiv.addEventListener('click', () => showMessageContent(msg.id)); fragment.appendChild(msgDiv); });
             inboxListEl.appendChild(fragment); displayedMessageIds = currentIds;
         };
        const showInboxList = () => { /* ... –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç setButtonsBusy ... */
             messageViewEl.style.display = 'none'; messageViewContentEl.innerHTML = '';
             accountSectionEl.style.display = 'block'; inboxSectionEl.style.display = 'block';
             setButtonsBusy(false); // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∫ —Å–ø–∏—Å–∫—É
             console.log("UI: Switched to inbox list view.");
         };
        async function showMessageContent(messageId) { /* ... –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç setButtonsBusy ... */
            if (!currentAccount) { showToast("–û—à–∏–±–∫–∞: –∞–∫–∫–∞—É–Ω—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.", "error"); return; }
            setButtonsBusy(true, 'busy'); // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ —Ñ–æ–Ω–∞

            accountSectionEl.style.display = 'none'; inboxSectionEl.style.display = 'none';
            messageViewEl.style.display = 'block'; messageViewContentEl.innerHTML = '<div id="message-view-loader">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∏—Å—å–º–∞...</div>';
            let messageData = null; let fetchError = null;
            try {
                if (!apiToken) { const gotToken = await getToken(); if (!gotToken) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω."); }
                const result = await fetchAPI(`/messages/${messageId}`, { needsAuth: true });
                if (result.ok) { messageData = result.data; }
                else { if (result.error?.message?.includes('401')) { const gotToken = await getToken(); if (!gotToken) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω."); const retryResult = await fetchAPI(`/messages/${messageId}`, { needsAuth: true }); if (retryResult.ok) { messageData = retryResult.data; } else { throw retryResult.error || new Error("–û—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏."); } } else { throw result.error || new Error("–û—à–∏–±–∫–∞ API."); } }
            } catch (error) { console.error("Failed fetch message content:", error); fetchError = error; }
            if (messageData) { const msg = messageData; const mailDate = new Date(msg.createdAt).toLocaleString('ru-RU'); const from = escapeHtml(msg.from?.address || '?'); const to = msg.to?.map(t => escapeHtml(t.address)).join(', ') || '?'; const subject = escapeHtml(msg.subject || '(–ë–µ–∑ —Ç–µ–º—ã)'); const body = escapeHtml(msg.text || msg.html?.join('\n') || '(–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞)'); messageViewContentEl.innerHTML = `<div class="message-header"><div><strong>–û—Ç:</strong> ${from}</div><div><strong>–ö–æ–º—É:</strong> ${to}</div><div><strong>–¢–µ–º–∞:</strong> ${subject}</div><div><strong>–î–∞—Ç–∞:</strong> ${mailDate}</div></div><div class="message-body">${body}</div>`; }
            else { const errorMsg = escapeHtml(fetchError?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'); messageViewContentEl.innerHTML = `<div class="inbox-placeholder error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∏—Å—å–º–∞: ${errorMsg}</div>`; }
            // –ö–Ω–æ–ø–∫–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ showInboxList –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–ù–∞–∑–∞–¥"
        }

        // --- –û—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è ---
        const loadAccountData = () => { /* ... –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */ const savedData = localStorage.getItem(LS_KEY); if (savedData) { try { const data = JSON.parse(savedData); if (data.address && data.password && data.id) { currentAccount = data; apiToken = null; console.log("Loaded account:", currentAccount.address); return true; } else { localStorage.removeItem(LS_KEY); } } catch (e) { localStorage.removeItem(LS_KEY); } } console.log("No valid account in localStorage."); currentAccount = null; apiToken = null; return false; };
        const saveAccountData = () => { /* ... –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */ if (currentAccount?.address && currentAccount?.password && currentAccount?.id) { try { const dataToSave = { address: currentAccount.address, password: currentAccount.password, id: currentAccount.id }; localStorage.setItem(LS_KEY, JSON.stringify(dataToSave)); console.log("Account saved."); } catch (e) { console.error("Error saving to localStorage:", e); showToast("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏.", "error"); } } };
        async function getToken() { /* ... –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */ if (!currentAccount?.address || !currentAccount?.password) { console.error("getToken: Missing credentials."); return false; } if (apiToken) return true; console.log('Requesting new token...'); const result = await fetchAPI('/token', { method: 'POST', needsAuth: false, body: { address: currentAccount.address, password: currentAccount.password } }); if (result.ok && result.data?.token) { apiToken = result.data.token; console.log('Token acquired.'); return true; } else { apiToken = null; const errorMsg = result.error?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω.'; console.error('Failed to get token:', errorMsg); if (!result.error?.message?.includes('401')) showToast(`–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${errorMsg}`, 'error'); return false; } }
        async function createNewAccount() { /* ... –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */ stopPolling(); console.log('Creating new account...'); setInboxState('loading'); updateAccountUI('loading'); let domainsResult, activeDomain, createResult; try { domainsResult = await fetchAPI('/domains', { needsAuth: false }); if (!domainsResult.ok || !domainsResult.data['hydra:member']?.length) throw domainsResult.error || new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ–º–µ–Ω.'); activeDomain = domainsResult.data['hydra:member'].find(d => d.isActive); if (!activeDomain) throw new Error('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤.'); } catch (error) { console.error("Failed get domains:", error); setInboxState('error', `–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${error.message}`); updateAccountUI('error'); return false; } const username = Math.random().toString(36).substring(2, 10); const password = generatePassword(); const address = `${username}@${activeDomain.domain}`; try { createResult = await fetchAPI('/accounts', { method: 'POST', needsAuth: false, body: { address, password } }); if (!createResult.ok || !createResult.data?.id) throw createResult.error || new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç.'); } catch (error) { console.error("Failed create account:", error); setInboxState('error', `–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${error.message}`); updateAccountUI('error'); return false; } currentAccount = { address: createResult.data.address, password: password, id: createResult.data.id }; apiToken = null; saveAccountData(); updateAccountUI('ok'); showToast(`–°–æ–∑–¥–∞–Ω –∞–¥—Ä–µ—Å: ${currentAccount.address}`, 'success'); try { const gotToken = await getToken(); if (gotToken) { await fetchMessages(); startPolling(); } else { setInboxState('error', '–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω, –Ω–æ –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.'); } } catch (error) { console.error("Error get token/messages after create:", error); setInboxState('error', `–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω, –Ω–æ –æ—à–∏–±–∫–∞: ${error.message}`); } return true; }
        async function fetchMessages(isPolling = false) { /* ... –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */ if (!currentAccount) { if (!isPolling) setInboxState('error', '–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω.'); return; } if (!isPolling) console.log("Fetching messages..."); else console.log("Polling..."); if (!isPolling) setInboxState('loading'); let messages = []; let fetchError = null; try { if (!apiToken) { const gotToken = await getToken(); if (!gotToken) throw new Error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏."); } const result = await fetchAPI('/messages?page=1', { needsAuth: true }); if (result.ok) { messages = result.data['hydra:member'] || []; } else { if (result.error?.message?.includes('401')) { const gotToken = await getToken(); if (!gotToken) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω."); const retryResult = await fetchAPI('/messages?page=1', { needsAuth: true }); if (retryResult.ok) { messages = retryResult.data['hydra:member'] || []; } else { throw retryResult.error || new Error("–û—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏."); } } else { throw result.error || new Error("–û—à–∏–±–∫–∞ API."); } } } catch (error) { console.error("Failed fetch messages:", error); fetchError = error; if (isPolling) console.warn("Polling failed:", error.message); } if (!isPolling || fetchError) { if (fetchError) { setInboxState('error', fetchError.message); } else { displayMessages(messages); } } else if (messages.length >= 0) { const newMessages = messages.filter(msg => !displayedMessageIds.has(msg.id)); if (newMessages.length > 0) { showToast(`–ù–æ–≤–æ–µ –ø–∏—Å—å–º–æ –æ—Ç ${escapeHtml(newMessages[0].from?.address || '?')}`, 'success'); if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.notificationOccurred('success'); displayMessages(messages); } else if(displayedMessageIds.size !== messages.length) { /* Handle potential deletions if needed */ displayMessages(messages); } } }
        function startPolling() { stopPolling(); if (!currentAccount) return; console.log(`Starting polling...`); setTimeout(() => fetchMessages(true), 2000); pollingIntervalId = setInterval(() => fetchMessages(true), POLLING_INTERVAL); }
        function stopPolling() { if (pollingIntervalId) { clearInterval(pollingIntervalId); pollingIntervalId = null; console.log("Polling stopped."); } }


        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
        // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function initializeApp() {
            console.log("initializeApp: Start");
            setButtonsBusy(true); // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ

            try {
                // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram API
                console.log("initializeApp: Initializing Telegram WebApp...");
                try {
                    if (window.Telegram && window.Telegram.WebApp) {
                        const tg = window.Telegram.WebApp;
                        tg.ready(); // –í—ã–∑—ã–≤–∞–µ–º ready, –Ω–æ –Ω–µ –∂–¥–µ–º –µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ
                        tg.expand();
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ (–ª—É—á—à–µ –¥–µ–ª–∞—Ç—å —ç—Ç–æ –∑–¥–µ—Å—å, –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö)
                        document.body.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color);
                        document.body.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color);
                        document.body.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color);
                        document.body.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color);
                        document.body.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color);
                        document.body.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color);
                        document.body.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color);
                        document.body.style.setProperty('--tg-theme-destructive-text-color', tg.themeParams.destructive_text_color || 'var(--app-destructive-text-color)');
                        console.log("initializeApp: Telegram WebApp theme applied.");
                    } else {
                        console.warn("initializeApp: Telegram WebApp script not found.");
                    }
                } catch (e) {
                    console.error("initializeApp: Telegram WebApp initialization error:", e);
                    showToast("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram", "error");
                    // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –ø—Ä–æ—Å—Ç–æ —Å—Ç–∏–ª–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏
                }

                // 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ UI (—Å—Ä–∞–∑—É –ø–æ—Å–ª–µ TG Init)
                console.log("initializeApp: Setting initial UI state...");
                updateAccountUI('loading'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞..."
                setInboxState('loading');   // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π..."
                setButtonsBusy(false);      // <<< –†–ê–ó–ë–õ–û–ö–ò–†–£–ï–ú –ö–ù–û–ü–ö–ò –ó–î–ï–°–¨!
                console.log("initializeApp: Initial UI set, buttons enabled.");

                // 3. –ó–∞–ø—É—Å–∫–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö –û–¢–î–ï–õ–¨–ù–û
                console.log("initializeApp: Starting background data load...");
                // –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º await –∑–¥–µ—Å—å, —á—Ç–æ–±—ã initializeApp –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å –±—ã—Å—Ç—Ä–æ
                loadDataInBackground();

            } catch (error) {
                // –õ–æ–≤–∏–º –æ—à–∏–±–∫–∏ –¢–û–õ–¨–ö–û —Å–∞–º–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ)
                console.error("initializeApp: CRITICAL UNEXPECTED ERROR:", error);
                // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                emailAddressEl.textContent = '–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê';
                emailAddressEl.classList.add('placeholder');
                setInboxState('error', `–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`);
                setButtonsBusy(false); // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∫–Ω–æ–ø–∫–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã
            }
             console.log("initializeApp: Function finished.");
        }

        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        async function loadDataInBackground() {
            console.log("loadDataInBackground: Start");
            setButtonsBusy(true); // –ë–ª–æ–∫–∏—Ä—É–µ–º –Ω–∞ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
            try {
                if (loadAccountData()) {
                    console.log("loadDataInBackground: Existing account found.");
                    updateAccountUI('ok'); // –ü–æ–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å
                    // setInboxState('loading') —É–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                    await fetchMessages(); // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
                    startPolling();
                } else {
                    console.log("loadDataInBackground: No account, creating new...");
                    // updateAccountUI('loading') / setInboxState('loading') —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —Ä–∞–Ω–µ–µ
                    const created = await createNewAccount(); // –ñ–¥–µ–º —Å–æ–∑–¥–∞–Ω–∏—è
                    if (!created) {
                        console.error("loadDataInBackground: Failed to create account.");
                         updateAccountUI('error'); // –û–±–Ω–æ–≤–ª—è–µ–º UI –Ω–∞ –æ—à–∏–±–∫—É, –µ—Å–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å
                         // setInboxState('error') —É–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ createNewAccount
                    }
                     // fetch/polling –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ createNewAccount
                }
                 console.log("loadDataInBackground: Data loading finished.");
            } catch (error) {
                 console.error("loadDataInBackground: Error during data loading:", error);
                 updateAccountUI('error');
                 setInboxState('error', `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`);
            } finally {
                 console.log("loadDataInBackground: Finished, unsetting busy state.");
                 setButtonsBusy(false); // –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
            }
        }


        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---
        // (–ò—Å–ø–æ–ª—å–∑—É—é—Ç setButtonsBusy)
        changeEmailBtn.addEventListener('click', async () => {
            if (isBusy) return;
            if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
            setButtonsBusy(true, 'change');
            try {
                stopPolling(); localStorage.removeItem(LS_KEY);
                currentAccount = null; apiToken = null;
                updateAccountUI('loading'); // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
                displayedMessageIds.clear(); showInboxList();
                setInboxState('loading');
                await createNewAccount();
            } catch (error) { console.error("Unexpected error change email:", error); showToast(`–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã: ${error.message}`, 'error'); updateAccountUI('error'); setInboxState('error', '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–º–µ–Ω—ã'); }
            finally { setButtonsBusy(false); } // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
        });

        refreshInboxBtn.addEventListener('click', async () => {
            if (isBusy || !currentAccount) return;
            if (window.Telegram?.WebApp?.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
            setButtonsBusy(true, 'refresh');
            showInboxList(); setInboxState('loading');
            try {
                await fetchMessages(false);
            } catch (error) { console.error("Unexpected error manual refresh:", error); showToast(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${error.message}`, 'error'); setInboxState('error', '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è'); }
            finally { setButtonsBusy(false); } // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
        });

        emailDisplayEl.addEventListener('click', () => {
             if (!currentAccount?.address || emailAddressEl.classList.contains('placeholder') || isBusy) return;
             navigator.clipboard.writeText(currentAccount.address)
                 .then(() => showToast('–ê–¥—Ä–µ—Å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!', 'success'))
                 .catch(err => { console.error('Clipboard copy error:', err); showToast('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.', 'error'); });
        });

        backToInboxBtn.addEventListener('click', showInboxList);
        window.addEventListener('beforeunload', stopPolling);

        // --- –ó–∞–ø—É—Å–∫ ---
        // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º DOMContentLoaded –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
        try {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } catch (e) {
            console.error("CRITICAL ERROR attaching DOMContentLoaded listener:", e);
            alert("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è!"); // –ü–æ—Å–ª–µ–¥–Ω—è—è –Ω–∞–¥–µ–∂–¥–∞
        }

    </script>
</body>
</html>
